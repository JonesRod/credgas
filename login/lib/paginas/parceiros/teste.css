<!-- Carrossel de Parceiros -->
<div class="parceiros-carousel owl-carousel">
    <?php 
        // Consulta para buscar parceiros que têm produtos em promoção, visíveis e aprovados
        $sql_parceiros = "
            SELECT DISTINCT mp.* 
            FROM meus_parceiros mp
            JOIN produtos p ON mp.id = p.id_parceiro
            WHERE 
                mp.status = 'ATIVO' 
                AND mp.aberto_fechado_manual = 'Aberto'
        ";

        $result_parceiros = $mysqli->query($sql_parceiros) or die($mysqli->error);

        // Variável para rastrear se algum parceiro será exibido
        $parceiro_exibido = false;

        if ($result_parceiros->num_rows > 0): 
            while ($parceiro = $result_parceiros->fetch_assoc()): 
                $id_parceiro = (int)$parceiro['id'];
                
                // Consulta para verificar se o parceiro possui produtos em promoção
                $sql_produtos = "
                    SELECT COUNT(*) AS total 
                    FROM produtos 
                    WHERE id_parceiro = $id_parceiro 
                        AND oculto != 'sim' 
                        AND produto_aprovado = 'sim' 
                        AND promocao = 'sim'
                ";
                $result_produtos = $mysqli->query($sql_produtos) or die($mysqli->error);
                $produto_data = $result_produtos->fetch_assoc();

                // Se o parceiro tiver ao menos um produto em promoção
                if ($produto_data['total'] > 0): 
                    $parceiro_exibido = true; // Marca que pelo menos um parceiro foi exibido
                    $logoParceiro = !empty($parceiro['logo']) ? htmlspecialchars($parceiro['logo']) : 'placeholder.jpg';
                    ?>
                    <div class="parceiro-card" onclick="window.location.href='loja_parceiro.php?id=<?php echo $id_parceiro; ?>&id_cliente=<?php echo $id; ?>'">
                        <img src="../parceiros/arquivos/<?php echo $logoParceiro; ?>" 
                            alt="Loja não encontrada">
                        <h3>
                            <?php
                                $nomeFantasia = htmlspecialchars($parceiro['nomeFantasia'] ?? '');
                                echo mb_strimwidth($nomeFantasia, 0, 18, '...'); // Limita a 18 caracteres com "..."
                            ?>
                        </h3>
                        <p><?php echo htmlspecialchars($parceiro['categoria'] ?? 'Categoria não informada'); ?></p>
                    </div>
                <?php endif; ?>
            <?php endwhile; ?>

            <?php 
            // Caso nenhum parceiro tenha produtos em promoção
            if (!$parceiro_exibido): ?>
                <p>Não há Lojas com promoção no momento.</p>
            <?php endif; ?>

        <?php else: ?>
            <p>Nenhum parceiro ativo no momento.</p>
        <?php endif; ?>
</div>
